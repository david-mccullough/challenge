<!DOCTYPE html>
<html lang="en">

<head>
  <title>The Minimalist Entrepreneur</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./style.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>

<body>
  <h1>The Minimalist Entrepreneur</h1>

  <div class="rating-box mt-1">
    <h1 id="rating-average" class="rating-average">0.0</h1>
    <div id="rating-average-stars" class="rating-stars-container"></div>
    <button id="btn-add-review" onclick="openReviewForm()">Add review</button>
  </div>

  <div class="separator"></div>

  <h2>Reviews</h2>
  <div id="reviews-box"></div>

  <div id="modal" style="display: none;">
    <a class="overlay" onclick="closeReviewForm()"></a>
    <div class="form-container">
      <h1>What's your rating?</h1>
      <p>Rating</p>
      <div id="new-rating-stars-container" class="rating-stars-container">
        <a class="star empty-star grow" onclick="setRating(1)"></a>
        <a class="star empty-star grow" onclick="setRating(2)"></a>
        <a class="star empty-star grow" onclick="setRating(3)"></a>
        <a class="star empty-star grow" onclick="setRating(4)"></a>
        <a class="star empty-star grow" onclick="setRating(5)"></a>
      </div>
      <p for="review-text">Review</label>
        <textarea type="text" id="review-content" placeholder="Start typing..." name="content" required maxlength="1000"></textarea>
        <button onclick="submitReview()">Submit Review</button>
    </div>
  </div>
</body>

<script>
  const serviceUrl = 'http://' + window.location.hostname + '/api/reviews';
  const reviewTemplate = ({
      rating,
      content
    }) =>
    `<div class="review">
      <div class="rating-stars-container">
        ${getStarsFromRating(rating)}       
      </div>
      <p><span class="rating">${rating}</span>, ${content}</p>
    </div>
`;

  var newReview = {}

  var inputEnabled = false;
  window.addEventListener('keydown', function(e) {
    if (inputEnabled && (e.keyCode && e.keyCode != 13) || (e.which && e.which != 13)) {
      focusReviewInput()
    }
  }, true);

  $(document).ready(async function() {
    initReview();
    await refreshReviews();
  });

  function openReviewForm() {
    inputEnabled = true;
    $("#modal").fadeIn(125);
  }

  function closeReviewForm() {
    inputEnabled = false;
    $("#modal").fadeOut(125);
  }

  function initReview() {
    newReview = {
      rating: 0,
      content: ''
    }
    hilightStars(0);
    let contentTextArea = document.getElementById("review-content")
    contentTextArea.value = '';
  }

  async function refreshReviews() {
    let reviews = await fetch(serviceUrl).then(response => response.json());

    // map reviews to html
    $('#reviews-box').html(reviews.map(reviewTemplate).join(''));

    // calculate and render average
    let average = reviews.reduce((a, b) => a + b.rating, 0) / reviews.length;
    let roundedAverage = (Math.round(average * 10) / 10).toFixed(1);

    $('#rating-average').html(roundedAverage);
    $("#rating-average-stars").html(getStarsFromRating(roundedAverage));
  }

  function setRating(value) {
    hilightStars(value)
    newReview.rating = value;
  }

  function hilightStars(value) {
    let stars = $("#new-rating-stars-container").children("a");
    for (let i = 1; i <= 5; i++) {
      let currentStar = stars[i - 1];
      if (i <= value) {
        currentStar.classList.add("full-star")
        currentStar.classList.remove("empty-star")
      } else {
        currentStar.classList.remove("full-star")
        currentStar.classList.add("empty-star")
      }
    }
  }

  async function submitReview() {
    let contentTextArea = document.getElementById("review-content")
    newReview.content = contentTextArea.value;

    const options = {
      method: 'POST',
      body: JSON.stringify(newReview),
      headers: {
        'Content-Type': 'application/json'
      }
    }

    await fetch(serviceUrl, options)
      .then(resp => {
        if (!resp.ok) {
          resp.json().then((errorJson) => alert(errorJson.message));
        } else {
          refreshReviews();
          closeReviewForm();
          initReview();
        }
      })
  }

  function focusReviewInput() {
    document.getElementById("review-content").focus();
  }

  function getStarsFromRating(rating) {
    let stars = [];
    for (let i = 1; i <= 5; i++)
      stars.push(`<div class="star ${i <= Math.round(rating) ? "full-star": "empty-star"}"></div>`)

    return stars.join('')
  }
</script>

</html>